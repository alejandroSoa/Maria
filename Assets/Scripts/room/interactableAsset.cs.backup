using UnityEngine;
using UnityEngine.InputSystem;
using UnityEngine.EventSystems;

/// <summary>
/// Script para assets interactuables que hacen zoom cuando se les da click.
/// Requiere un BoxCollider2D para detectar clicks.
/// Añade este script a cada objeto con el que el jugador pueda interactuar.
/// </summary>
[RequireComponent(typeof(BoxCollider2D))]
[RequireComponent(typeof(Rigidbody2D))]
public class interactableAsset : MonoBehaviour
{
    [Header("Configuraci�n de Zoom")]
    [Tooltip("Tama�o de la c�mara cuando hace zoom (menor = m�s cerca)")]
    [SerializeField] private float zoomedSize = 2.5f;

    [Tooltip("Tama�o normal de la c�mara (sin zoom)")]
    [SerializeField] private float normalSize = 5f;

    [Tooltip("Velocidad de la animaci�n de zoom")]
    [SerializeField] private float zoomSpeed = 5f;

    [Header("Referencias")]
    [Tooltip("Referencia a la c�mara principal. Si se deja vac�o, se busca autom�ticamente")]
    [SerializeField] private Camera mainCamera;

    [Tooltip("Canvas con los botones de navegaci�n. Se oculta durante el zoom")]
    [SerializeField] private GameObject navigationCanvas;

    private static interactableAsset currentZoomedAsset = null;
    private static GameObject canvasReference = null;
    private bool isZoomed = false;
    private Vector3 originalCameraPosition;
    private Vector3 targetCameraPosition;

    private void Start()
    {
        // Buscar la c�mara principal si no est� asignada
        if (mainCamera == null)
        {
            mainCamera = Camera.main;
        }

        if (mainCamera == null)
        {
            Debug.LogError($"InteractableAsset en {gameObject.name}: No se encontr� la Main Camera.");
        }

        // Buscar el Canvas si no est� asignado
        if (navigationCanvas == null)
        {
            navigationCanvas = GameObject.Find("Canvas");
        }

        // Guardar referencia est�tica al Canvas para que todos los assets la compartan
        if (navigationCanvas != null && canvasReference == null)
        {
            canvasReference = navigationCanvas;
        }
    }

    private void OnMouseDown()
    {
        // Si este objeto ya est� con zoom, hacer zoom out
        if (isZoomed)
        {
            ZoomOut();
        }
        else
        {
            // Si hay otro objeto con zoom, quitarle el zoom primero
            if (currentZoomedAsset != null && currentZoomedAsset != this)
            {
                currentZoomedAsset.ZoomOut();
            }

            ZoomIn();
        }
    }

    /// <summary>
    /// Hace zoom in hacia este asset
    /// </summary>
    private void ZoomIn()
    {
        if (mainCamera == null) return;

        isZoomed = true;
        currentZoomedAsset = this;

        // Ocultar el Canvas de navegaci�n
        if (canvasReference != null)
        {
            canvasReference.SetActive(false);
        }

        // Guardar la posici�n original de la c�mara
        originalCameraPosition = mainCamera.transform.position;

        // Calcular la posici�n target (mantener el Z de la c�mara)
        targetCameraPosition = new Vector3(
            transform.position.x,
            transform.position.y,
            originalCameraPosition.z
        );

        // Iniciar la animaci�n de zoom
        StopAllCoroutines();
        StartCoroutine(AnimateZoom(zoomedSize, targetCameraPosition));
    }

    /// <summary>
    /// Hace zoom out y vuelve a la vista normal
    /// </summary>
    private void ZoomOut()
    {
        if (mainCamera == null) return;

        isZoomed = false;
        currentZoomedAsset = null;

        // Mostrar el Canvas de navegaci�n nuevamente
        if (canvasReference != null)
        {
            canvasReference.SetActive(true);
        }

        // Iniciar la animaci�n de zoom out
        StopAllCoroutines();
        StartCoroutine(AnimateZoom(normalSize, originalCameraPosition));
    }

    /// <summary>
    /// Anima el zoom de la c�mara suavemente
    /// </summary>
    private System.Collections.IEnumerator AnimateZoom(float targetSize, Vector3 targetPosition)
    {
        float currentSize = mainCamera.orthographicSize;
        Vector3 currentPosition = mainCamera.transform.position;
        float elapsed = 0f;

        while (elapsed < 1f)
        {
            elapsed += Time.deltaTime * zoomSpeed;
            float t = Mathf.SmoothStep(0f, 1f, elapsed);

            // Interpolar el tama�o de la c�mara
            mainCamera.orthographicSize = Mathf.Lerp(currentSize, targetSize, t);

            // Interpolar la posici�n de la c�mara
            mainCamera.transform.position = Vector3.Lerp(currentPosition, targetPosition, t);

            yield return null;
        }

        // Asegurar que llega exactamente al valor final
        mainCamera.orthographicSize = targetSize;
        mainCamera.transform.position = targetPosition;
    }

    /// <summary>
    /// M�todo p�blico para hacer zoom out desde fuera (por ejemplo, desde un bot�n)
    /// </summary>
    public static void ResetZoom()
    {
        if (currentZoomedAsset != null)
        {
            currentZoomedAsset.ZoomOut();
        }
    }
}
